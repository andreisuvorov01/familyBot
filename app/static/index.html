<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ–º–µ–π–Ω—ã–µ –∑–∞–¥–∞—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .card { background-color: var(--tg-theme-secondary-bg-color); }
        .btn-primary { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
    </style>
</head>
<body class="p-4 font-sans">
    <header class="flex justify-between items-center mb-6">
        <h1 class="text-xl font-bold">–ú–æ–∏ –∑–∞–¥–∞—á–∏ üìù</h1>
        <span id="role-badge" class="px-2 py-1 rounded text-xs font-medium bg-blue-500 text-white">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    </header>

    <div id="task-list" class="space-y-3">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∑–∞–¥–∞—á–∏ -->
        <p class="text-center opacity-50">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ–ª...</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        async function fetchTasks() {
            try {
                const response = await fetch('/api/tasks/', {
                    method: 'GET',
                    headers: {
                        'X-TG-Data': tg.initData // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                    }
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞');
                const tasks = await response.json();
                renderTasks(tasks);
            } catch (err) {
                document.getElementById('task-list').innerHTML = `<p class="text-red-500 text-center">${err.message}</p>`;
            }
        }

        function renderTasks(tasks) {
            const list = document.getElementById('task-list');
            if (tasks.length === 0) {
                list.innerHTML = '<p class="text-center opacity-50">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–¥–æ—Ö–Ω–∏—Ç–µ! ‚òï</p>';
                return;
            }

            list.innerHTML = tasks.map(task => `
                <div class="card p-4 rounded-xl shadow-sm border border-gray-700/10">
                    <div class="flex justify-between items-start">
                        <h3 class="font-semibold">${task.title}</h3>
                        <span class="text-[10px] uppercase tracking-wider opacity-60">${task.visibility}</span>
                    </div>
                    <p class="text-sm opacity-80 mt-1">${task.description || ''}</p>
                    <div class="mt-3 flex justify-end">
                        <button onclick="completeTask(${task.id})" class="btn-primary px-4 py-1 rounded-lg text-sm">–ì–æ—Ç–æ–≤–æ</button>
                    </div>
                </div>
            `).join('');
        }

        fetchTasks();
    </script>
</body>
</html>
